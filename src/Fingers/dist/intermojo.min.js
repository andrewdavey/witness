(function(h){fingersConfig={base:{name:"base"},fingers:{name:"fingers"},controller:{selector:"editable"}};var f=function(a){if(this instanceof arguments.callee){this._init.apply(this,a.callee?a:arguments);return this}else return new arguments.callee(arguments)};$.extend(f,{addStaticMethods:function(a){$.extend(this,a)},addInstanceMethods:function(a){$.extend(this.prototype,a)},createChild:function(){var a=function(b){if(this instanceof arguments.callee){this.init.apply(this,b.callee?b:arguments);
return this}else return new arguments.callee(arguments)};$.extend(a,this);$.extend(a.prototype,this.prototype);return a}});f.addInstanceMethods({_init:function(a){this.init(a);return this},init:function(a){this.config=fingersConfig.base;$.extend(this.config,a);return this},isMyMessage:function(a){return!a||a&&a.recipientId===this.uid?true:false}});var d=f.createChild("fingers");d.addStaticMethods({util:f.createChild("util")});d.addInstanceMethods({});String.prototype.toCamelCase=function(){return this.replace(/\s[a-z0-9]/g,
function(a){return a.toUpperCase()})};h.fingers=d;d.util.addStaticMethods({formData:f.createChild()});d.util.formData.addStaticMethods({uid:0});d.util.formData.addInstanceMethods({init:function(){this.fields={}},registerField:function(a){var b;if(a){a.selector?b=a:b=$(a);a=b.val()}else throw"Invalid DOM element ";this.fields[++d.util.formData.uid]={element:b,storedValue:a};return d.util.formData.uid},value:function(a,b){if(typeof a==="number"&&this.fields[a])if(arguments.length>1){this.fields[a].storedValue=
b;this.fields[a].element.val(b);d.broker.publish("event field value changed",d.util.message(a,b))}else return this.fields[a].storedValue;else return false},element:function(a){return a&&typeof a==="number"&&this.fields[a]&&this.fields[a].element?this.fields[a].element:false}});d.formData=d.util.formData();d.util.addStaticMethods({broker:f.createChild()});d.util.broker.addInstanceMethods({init:function(){this.subscribers={};this.subscribers={};this.subscribersAsync={};return this},publish:function(a){var b,
c;this.subscribers[a]||(this.subscribers[a]=[]);this.subscribersAsync[a]||(this.subscribersAsync[a]=[]);var e=Array.prototype.slice.call(arguments,1);for(c=0;c<this.subscribersAsync[a].length;c++){b=this.subscribersAsync[a][c];b.apply(this,e)}for(c=0;c<this.subscribers[a].length;c++){b=this.subscribers[a][c];b.apply(this,e)}return this},subscribe:function(a,b,c){this.subscribers[a]||(this.subscribers[a]=[]);var e=Array.prototype.slice.call(arguments,3);this.subscribers[a].push(function(){var g=Array.prototype.slice.call(arguments,
0);b[c].apply(b||h,e.concat(g))});return this},subscribeAsync:function(a,b,c){this.subscribersAsync[a]||(this.subscribersAsync[a]=[]);var e=Array.prototype.slice.call(arguments,3);this.subscribersAsync[a].push(function(){var g=Array.prototype.slice.call(arguments,0);setTimeout(function(){b[c].apply(b||h,e.concat(g))},0)});return this}});d.addStaticMethods({broker:d.util.broker()});d.util.controller=f.createChild();d.util.controller.addInstanceMethods({init:function(){var a=this,b=$("."+fingersConfig.controller.selector);
this.editViews=[];this.staticViews=[];this.length=b.length;b.each(function(){a.invokeView($(this))});return this},invokeView:function(a){var b,c,e="",g;a.attr("class").split(" ").forEach(function(i){if(b=i.match(/^view\-([A-Za-z0-9\-]+)$/))c=b[1]});e=c.replace(/\-/g," ").toCamelCase().replace(/\s/g,"");g=d.formData.registerField(a);this.registerEditView(d.editView(e,g));a.hide();return this},registerEditView:function(a){this.editViews.push(a);return this}});d.controller=d.util.controller;d.addStaticMethods({editView:f.createChild("editView")});
d.editView.addInstanceMethods({init:function(a,b){this.viewType=a;this.uid=b;this.view=d.middleware[this.viewType]?d.middleware[this.viewType](this.uid):d.middleware.singleText(this.uid);this.registerSubscriptions();return this},registerSubscriptions:function(){d.broker.subscribe("request edit data",this,"requestEditData");d.broker.subscribe("request update data",this,"requestUpdateData").subscribe("request cancel update",this,"requestCancelUpdate");return this},requestEditData:function(a){if(this.isMyMessage(a)){d.broker.publish("event editing begins",
d.util.message(this.uid,null));this.view.beginEdit()}return this},requestCancelUpdate:function(a){this.isMyMessage(a)&&d.broker.publish("event editing complete",d.util.message(this.uid,null));return this},requestUpdateData:function(a){if(this.isMyMessage(a)){if(a.element)for(var b=0;b<a.element.length;b++)d.formData.element(this.uid).find("input[type="+a.element[b].attr("type")+"]").first().replaceWith(a.element[b]);else d.formData.value(this.uid,a.value);d.broker.publish("event data updated",d.util.message(this.uid,
null));d.broker.publish("event editing complete",d.util.message(this.uid,null))}return this}});d.addStaticMethods({staticView:f.createChild("staticView")});d.staticView.addStaticMethods({uid:0});d.staticView.addInstanceMethods({init:function(a){this.uid=a;d.formData.value(this.uid);d.formData.element(this.uid).after(this.element);this.registerSubscriptions();return this},registerSubscriptions:function(){d.broker.subscribe("event editing begins",this,"hide").subscribe("event editing complete",this,
"show");return this},hide:function(a){this.isMyMessage(a)&&this.element.hide();return this},show:function(a){if(this.isMyMessage(a)){a=d.formData.value(this.uid);if(a==="")a="Click to edit";this.element.html(a);this.element.show()}return this}});d.util.addStaticMethods({message:f.createChild("message")});d.util.message.addInstanceMethods({init:function(a,b,c){this.recipientId=a;this.value=b;if(c)this.element=c;return this}});d.addStaticMethods({middleware:f.createChild("middleware")});d.middleware.addInstanceMethods({init:function(a){this.uid=
a;this.createStaticView();this.createEditView();return this},createStaticView:function(){var a=this;this.staticView=$('<div class="static-view field"></div>');d.formData.element(this.uid).after(this.staticView);this.staticView.bind("click",function(b){b.preventDefault();d.broker.publish("request edit data",d.util.message(a.uid,null))});this.showStaticView();return this},createEditView:function(){this.editView=$('<input type="text" class="edit-view-control single-text" />');return this},showStaticView:function(){var a=
d.formData.value(this.uid);if(a==="")a="Click to edit";this.staticView.html(a).show();return this},hideStaticView:function(){this.staticView.hide();return this},showEditView:function(){d.formData.element(this.uid).after(this.editView);this.editView.val(d.formData.value(this.uid));return this},hideEditView:function(){this.editView.remove();return this},persistChange:function(){this.okay(this.editView.val());return this},beginEdit:function(){var a=this;if(d.formData.element(this.uid)){this.hideStaticView();
this.showEditView();this.editView.bind("blur",function(){a.persistChange()}).bind("keydown",function(b){b.which===13&&a.persistChange();b.which===27&&a.cancel()}).focus()}return this},endEdit:function(){this.hideEditView();this.showStaticView();return this},okay:function(a){d.broker.publish("request update data",d.util.message(this.uid,a));this.endEdit();return this},cancel:function(){d.broker.publish("request cancel update",d.util.message(this.uid,null));this.endEdit();return this}});(function(a){a.middleware.addStaticMethods({singleText:a.middleware.createChild("singletext-middleware")});
a.middleware.singleText.addInstanceMethods({})})(d);(function(a){a.middleware.addStaticMethods({bool:a.middleware.createChild("bool-middleware")});a.middleware.bool.addInstanceMethods({createEditView:function(){this.editView=$('<input type="checkbox" class="edit-view-control bool" />')},persistChange:function(){this.okay(this.editView.is(":checked").toString())},beginEdit:function(){var b=this;if(a.formData.element(this.uid)){this.showEditView();this.hideStaticView();a.formData.value(this.uid)===
"true"?this.editView.attr("checked","checked"):this.editView.removeAttr("checked");this.editView.bind("blur",function(){b.blurTimeout=setTimeout(function(){b.persistChange()},250)}).bind("change",function(){if(b.blurTimeout!==-1){clearTimeout(b.blurTimeout);b.blurTimeout=-1}$(this).focus()}).bind("keydown",function(c){c.which===13&&b.persistChange(this);c.which===27&&b.cancel()});this.editView.focus()}}})})(d);(function(a){a.middleware.addStaticMethods({select:a.middleware.createChild("select-middleware")});
a.middleware.select.addInstanceMethods({showStaticView:function(){var b=a.formData.value(this.uid);b=b===""?"Click to edit":a.formData.element(this.uid).find(":selected").html();this.staticView.html(b).show();return this},createEditView:function(){var b=a.formData.element(this.uid).find("option");this.editView=$('<select class="edit-view-control select"></select>');this.editView.append(b.clone());return this}})})(d);(function(a){a.middleware.addStaticMethods({multiText:a.middleware.createChild("select-middleware")});
a.middleware.multiText.addInstanceMethods({showStaticView:function(){var b=a.formData.value(this.uid);if(b==="")b="Click to edit";this.staticView.html(b.replace(/\|/g,", ")).show();return this},persistChange:function(){var b=[];this.editView.find("input.single-text").each(function(){var c=$(this).val();c&&c!==""&&b.push($(this).val())});this.okay(b.toString().replace(/,/g,"|"));return this},beginEdit:function(){var b=this;if(a.formData.element(this.uid)){this.hideStaticView();this.showEditView();
a.formData.value(this.uid).split("|").forEach(function(c){this.editView.append('<input type="text" value="'+c+'" class="edit-view-control single-text" />')},this);this.editView.append('<input type="text" value="" class="edit-view-control single-text last" />');this.editView.bind("keydown",function(c){c.which===13&&b.persistChange();c.which===27&&b.cancel();if(c.which===9)if($(c.target).is(".last")&&c.shiftKey===false){$(c.target).removeClass("last");b.editView.append('<input type="text" value="" class="edit-view-control single-text last" />')}});
this.editView.children(".last").focus();setTimeout(function(){$(document).bind("click",{that:b},b.checkForClick)},250)}return this},checkForClick:function(b){var c=b.data.that;$(b.target).is("input",c.editView)||c.persistChange();return this},endEdit:function(){$(document).unbind("click",this.checkForClick);this.hideEditView();this.showStaticView();this.editView.empty();return this},createEditView:function(){this.editView=$('<div class="edit-view-control multi-text"></div>');return this}})})(d);(function(a){a.middleware.addStaticMethods({multiTextLimit5:a.middleware.createChild("select-middleware")});
a.middleware.multiTextLimit5.addInstanceMethods({showStaticView:function(){var b=a.formData.value(this.uid);if(b==="")b="Click to edit";this.staticView.html(b.replace(/\|/g,", ")).show();return this},persistChange:function(){var b=[];this.editView.find("input.single-text").each(function(){var c=$(this).val();c&&c!==""&&b.push($(this).val())});this.okay(b.toString().replace(/,/g,"|"));return this},beginEdit:function(){var b=this,c;if(a.formData.element(this.uid)){this.hideStaticView();this.showEditView();
c=a.formData.value(this.uid).split("|");this.length=0;c.forEach(function(e){this.editView.append('<input type="text" value="'+e+'" class="edit-view-control single-text" />');this.length++},this);for(c=this.length;c<5;c++)this.editView.append('<input type="text" value="" class="edit-view-control single-text last" />');this.editView.bind("keydown",function(e){e.which===13&&b.persistChange();e.which===27&&b.cancel()});this.editView.children(".last").focus();setTimeout(function(){$(document).bind("click",
{that:b},b.checkForClick)},250)}return this},checkForClick:function(b){var c=b.data.that;$(b.target).is("input",c.editView)||c.persistChange();return this},endEdit:function(){$(document).unbind("click",this.checkForClick);this.hideEditView();this.showStaticView();this.editView.empty();return this},createEditView:function(){this.editView=$('<div class="edit-view-control multi-text"></div>');return this}})})(d);(function(a){a.middleware.addStaticMethods({datePicker:a.middleware.createChild("middleware")});
a.middleware.datePicker.addInstanceMethods({createEditView:function(){this.editView=$('<input type="text" class="edit-view-control date-picker" />');return this},beginEdit:function(){var b=this;if(a.formData.element(this.uid)){this.hideStaticView();a.formData.element(this.uid).after(this.editView);this.editView.datepicker({onSelect:function(){b.persistChange()},onClose:function(){b.cancel()},changeYear:"true",dateFormat:"dd M yy"}).focus()}return this},endEdit:function(){this.editView.datepicker("destroy");
this.hideEditView();this.showStaticView();return this}})})(d);(function(a){a.middleware.addStaticMethods({ckEditor:a.middleware.createChild("middleware")});a.middleware.ckEditor.addInstanceMethods({createEditView:function(){this.editView=$('<textarea type="text" class="edit-view-control ckeditor" ></textarea>');return this},beginEdit:function(){var b=this;if(a.formData.element(this.uid)){this.hideStaticView();a.formData.element(this.uid).after(this.editView);this.editView.val(a.formData.value(this.uid));
this.editView.ckeditor({skin:"kama",toolbar:"Basic"});this.ckEdit=this.editView.ckeditorGet();setTimeout(function(){$(document).bind("click",{that:b},b.checkForClick)},250)}return this},endEdit:function(){$(document).unbind("click",this.checkForClick);this.ckEdit.destroy();this.hideEditView();this.showStaticView();return this},checkForClick:function(b){var c=b.data.that;$(b.target).is("#cke_editor1")||c.persistChange();return this}})})(d);(function(a){a.middleware.addStaticMethods({multiSelect:a.middleware.createChild("multiselect-middleware")});
a.middleware.multiSelect.addInstanceMethods({showStaticView:function(){console.log("creating multi select static view");var b=a.formData.value(this.uid);if(b){b="";a.formData.element(this.uid).find(":selected").each(function(){b+=$(this).html()+", "});b=b.slice(0,-2)}else b="Click to edit";this.staticView.html(b).show();return this},createEditView:function(){console.log("creating multi select edit view");var b=a.formData.element(this.uid).find("option");this.editView=$('<select class="edit-view-control multi-select" size="8" multiple="multiple"></select>');
this.editView.append(b.clone());return this},persistChange:function(){var b=this.editView.val();b&&b.length>5?console.log("static view too many selected"):this.okay(b);return this}})})(d);(function(a){a.middleware.addStaticMethods({typeAhead:a.middleware.createChild("typeahead-middleware")});a.middleware.typeAhead.addInstanceMethods({createEditView:function(){this.editView=$('<input type="text" class="edit-view-control type-ahead" />');return this},beginEdit:function(){var b=this;if(a.formData.element(this.uid)){this.hideStaticView();
a.formData.element(this.uid).after(this.editView);a.formData.element(this.uid).attr("data-lookupUrl");this.editView.val(a.formData.value(this.uid)).bind("blur",function(){b.blurTimeout=setTimeout(function(){b.cancel()},250)}).bind("keydown",function(c){c.which===27&&b.cancel()}).focus().autocomplete({source:["c++","java","php","coldfusion","javascript","asp","ruby"],select:function(c,e){b.editView.val(e.item.value);b.persistChange()},minLength:2})}return this}})})(d);(function(a){a.middleware.addStaticMethods({multiTypeAhead:a.middleware.createChild("multi-type-ahead-middleware")});
a.middleware.multiTypeAhead.addInstanceMethods({showStaticView:function(){var b=a.formData.value(this.uid);if(b==="")b="Click to edit";this.staticView.html(b.replace(/\|/g,", ")).show();return this},persistChange:function(){var b=[];this.editView.find("input.single-text").each(function(){var c=$(this).val();c&&c!==""&&b.push($(this).val())});this.okay(b.toString().replace(/,/g,"|"));return this},beginEdit:function(){var b=this,c;if(a.formData.element(this.uid)){this.hideStaticView();this.showEditView();
c=a.formData.value(this.uid).split("|");this.length=0;c.forEach(function(e){this.editView.append('<input type="text" value="'+e+'" class="edit-view-control single-text" />');this.length++},this);for(c=this.length;c<5;c++)this.editView.append('<input type="text" value="" class="edit-view-control single-text last" />');this.editView.children().each(function(){$(this).autocomplete({source:["c++","java","php","coldfusion","javascript","asp","ruby"],select:function(e,g){$(this).val(g.item.value)},minLength:2}).bind("blur",
function(){})});this.editView.bind("keydown",function(e){e.which===13&&b.persistChange();e.which===27&&b.cancel()});this.editView.children(".last").focus();setTimeout(function(){$(document).bind("click",{that:b},b.checkForClick)},250)}return this},checkForClick:function(b){var c=b.data.that;!$(b.target).is("input",c.editView)&&!$(b.target).is("ul.ui-autocomplete li a")&&c.persistChange();return this},endEdit:function(){$(document).unbind("click",this.checkForClick);this.hideEditView();this.showStaticView();
this.editView.empty();return this},createEditView:function(){this.editView=$('<div class="edit-view-control multi-text"></div>');return this}})})(d);(function(a){a.middleware.addStaticMethods({urlOrFileUpload:a.middleware.createChild("urlorfileupload-middleware")});a.middleware.urlOrFileUpload.addInstanceMethods({showStaticView:function(){var b=a.formData.element(this.uid).find("input[type=text]").first().val();if(b==="")b="Click to edit";this.staticView.html(b).show();return this},showEditView:function(){a.formData.element(this.uid).after(this.editView);
this.editView.find("input[type=text]").first().val(a.formData.element(this.uid).find("input[type=text]").first().val());return this},createEditView:function(){var b='<span class="edit-view-control single-text url-or-file-upload">';b+='<input type="radio" name="fileOrUrl" value="text" checked="checked" />';b+='<input type="text" /> <input type="radio" name="fileOrUrl" value="file" /><input type="file" disabled="disabled" />';b+="</span>";this.editView=$(b);return this},persistChange:function(){this.editView.find("input[type=radio]:checked").val()===
"file"&&this.editView.find("input[type=text]").first().val("manually updated file");this.okay(null,[this.editView.find("input[type=file]").first().clone(),this.editView.find("input[type=text]").first().clone()]);return this},okay:function(b,c){a.broker.publish("request update data",a.util.message(this.uid,b,c));this.endEdit();return this},checkForClick:function(b){var c=b.data.that,e=true;if($(b.target).is("span",c.editView))e=false;c.editView.children().each(function(){if($(b.target).is(this.tagName,
this))e=false});e&&c.persistChange();return this},beginEdit:function(){var b=this;if(a.formData.element(this.uid)){this.hideStaticView();this.showEditView();this.editView.find("input[type=radio]").bind("click",function(c){if($(c.currentTarget).val()==="text"){$(b.editView.find("input[type=text]").first()).removeAttr("disabled");$(b.editView.find("input[type=file]").first()).attr("disabled","disabled")}else{$(b.editView.find("input[type=text]").first()).attr("disabled","disabled");$(b.editView.find("input[type=file]").first()).removeAttr("disabled")}});
setTimeout(function(){$(document).bind("click",{that:b},b.checkForClick)},250)}return this}})})(d);h.base=f})(window);
