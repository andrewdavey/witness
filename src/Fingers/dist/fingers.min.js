(function(h){fingersConfig={base:{name:"base"},fingers:{name:"fingers"},controller:{selector:"editable"}};var f=function(a){if(this instanceof arguments.callee){this._init.apply(this,a.callee?a:arguments);return this}else return new arguments.callee(arguments)};$.extend(f,{addStaticMethods:function(a){$.extend(this,a)},addInstanceMethods:function(a){$.extend(this.prototype,a)},createChild:function(){var a=function(b){if(this instanceof arguments.callee){this.init.apply(this,b.callee?b:arguments);
return this}else return new arguments.callee(arguments)};$.extend(a,this);$.extend(a.prototype,this.prototype);return a}});f.addInstanceMethods({_init:function(a){this.init(a);return this},init:function(a){this.config=fingersConfig.base;$.extend(this.config,a);return this},isMyMessage:function(a){return!a||a&&a.recipientId===this.uid?true:false}});var c=f.createChild("fingers");c.addStaticMethods({util:f.createChild("util")});c.addInstanceMethods({});String.prototype.toCamelCase=function(){return this.replace(/\s[a-z0-9]/g,
function(a){return a.toUpperCase()})};h.fingers=c;c.util.addStaticMethods({formData:f.createChild()});c.util.formData.addStaticMethods({uid:0});c.util.formData.addInstanceMethods({init:function(){this.fields={}},registerField:function(a){var b;if(a){a.selector?b=a:b=$(a);a=b.val()}else throw"Invalid DOM element ";this.fields[++c.util.formData.uid]={element:b,storedValue:a};return c.util.formData.uid},value:function(a,b){if(typeof a==="number"&&this.fields[a])if(arguments.length>1){this.fields[a].storedValue=
b;this.fields[a].element.val(b);c.broker.publish("event field value changed",c.util.message(a,b))}else return this.fields[a].storedValue;else return false},element:function(a){return a&&typeof a==="number"&&this.fields[a]&&this.fields[a].element?this.fields[a].element:false}});c.formData=c.util.formData();c.util.addStaticMethods({broker:f.createChild()});c.util.broker.addInstanceMethods({init:function(){this.subscribers={};this.subscribers={};this.subscribersAsync={};return this},publish:function(a){var b,
d;this.subscribers[a]||(this.subscribers[a]=[]);this.subscribersAsync[a]||(this.subscribersAsync[a]=[]);var e=Array.prototype.slice.call(arguments,1);for(d=0;d<this.subscribersAsync[a].length;d++){b=this.subscribersAsync[a][d];b.apply(this,e)}for(d=0;d<this.subscribers[a].length;d++){b=this.subscribers[a][d];b.apply(this,e)}return this},subscribe:function(a,b,d){this.subscribers[a]||(this.subscribers[a]=[]);var e=Array.prototype.slice.call(arguments,3);this.subscribers[a].push(function(){var g=Array.prototype.slice.call(arguments,
0);b[d].apply(b||h,e.concat(g))});return this},subscribeAsync:function(a,b,d){this.subscribersAsync[a]||(this.subscribersAsync[a]=[]);var e=Array.prototype.slice.call(arguments,3);this.subscribersAsync[a].push(function(){var g=Array.prototype.slice.call(arguments,0);setTimeout(function(){b[d].apply(b||h,e.concat(g))},0)});return this}});c.addStaticMethods({broker:c.util.broker()});c.util.controller=f.createChild();c.util.controller.addInstanceMethods({init:function(){var a=this,b=$("."+fingersConfig.controller.selector);
this.editViews=[];this.staticViews=[];this.length=b.length;b.each(function(){a.invokeView($(this))});return this},invokeView:function(a){var b,d,e="",g;a.attr("class").split(" ").forEach(function(i){if(b=i.match(/^view\-([A-Za-z0-9\-]+)$/))d=b[1]});e=d.replace(/\-/g," ").toCamelCase().replace(/\s/g,"");g=c.formData.registerField(a);this.registerEditView(c.editView(e,g));a.hide();return this},registerEditView:function(a){this.editViews.push(a);return this}});c.controller=c.util.controller;c.addStaticMethods({editView:f.createChild("editView")});
c.editView.addInstanceMethods({init:function(a,b){this.viewType=a;this.uid=b;this.view=c.middleware[this.viewType]?c.middleware[this.viewType](this.uid):c.middleware.singleText(this.uid);this.registerSubscriptions();return this},registerSubscriptions:function(){c.broker.subscribe("request edit data",this,"requestEditData");c.broker.subscribe("request update data",this,"requestUpdateData").subscribe("request cancel update",this,"requestCancelUpdate");return this},requestEditData:function(a){if(this.isMyMessage(a)){c.broker.publish("event editing begins",
c.util.message(this.uid,null));this.view.beginEdit()}return this},requestCancelUpdate:function(a){this.isMyMessage(a)&&c.broker.publish("event editing complete",c.util.message(this.uid,null));return this},requestUpdateData:function(a){if(this.isMyMessage(a)){c.formData.value(this.uid,a.value);c.broker.publish("event data updated",c.util.message(this.uid,null));c.broker.publish("event editing complete",c.util.message(this.uid,null))}return this}});c.addStaticMethods({staticView:f.createChild("staticView")});
c.staticView.addStaticMethods({uid:0});c.staticView.addInstanceMethods({init:function(a){this.uid=a;c.formData.value(this.uid);c.formData.element(this.uid).after(this.element);this.registerSubscriptions();return this},registerSubscriptions:function(){c.broker.subscribe("event editing begins",this,"hide").subscribe("event editing complete",this,"show");return this},hide:function(a){this.isMyMessage(a)&&this.element.hide();return this},show:function(a){if(this.isMyMessage(a)){a=c.formData.value(this.uid);
if(a==="")a="Click to edit";this.element.html(a);this.element.show()}return this}});c.util.addStaticMethods({message:f.createChild("message")});c.util.message.addInstanceMethods({init:function(a,b){this.recipientId=a;this.value=b;return this}});c.addStaticMethods({middleware:f.createChild("middleware")});c.middleware.addInstanceMethods({init:function(a){this.uid=a;this.createStaticView();this.createEditView();return this},createStaticView:function(){var a=this;this.staticView=$('<div class="static-view field"></div>');
c.formData.element(this.uid).after(this.staticView);this.staticView.bind("click",function(b){b.preventDefault();c.broker.publish("request edit data",c.util.message(a.uid,null))});this.showStaticView();return this},createEditView:function(){this.editView=$('<input type="text" class="edit-view-control single-text" />');return this},showStaticView:function(){var a=c.formData.value(this.uid);if(a==="")a="Click to edit";this.staticView.html(a).show();return this},hideStaticView:function(){this.staticView.hide();
return this},showEditView:function(){c.formData.element(this.uid).after(this.editView);this.editView.val(c.formData.value(this.uid));return this},hideEditView:function(){this.editView.remove();return this},persistChange:function(){this.okay(this.editView.val());return this},beginEdit:function(){var a=this;if(c.formData.element(this.uid)){this.hideStaticView();this.showEditView();this.editView.bind("blur",function(){a.persistChange()}).bind("keydown",function(b){b.which===13&&a.persistChange();b.which===
27&&a.cancel()}).focus()}return this},endEdit:function(){this.hideEditView();this.showStaticView();return this},okay:function(a){c.broker.publish("request update data",c.util.message(this.uid,a));this.endEdit();return this},cancel:function(){c.broker.publish("request cancel update",c.util.message(this.uid,null));this.endEdit();return this}});(function(a){a.middleware.addStaticMethods({singleText:a.middleware.createChild("singletext-middleware")});a.middleware.singleText.addInstanceMethods({})})(c);
(function(a){a.middleware.addStaticMethods({bool:a.middleware.createChild("bool-middleware")});a.middleware.bool.addInstanceMethods({createEditView:function(){this.editView=$('<input type="checkbox" class="edit-view-control bool" />')},persistChange:function(){this.okay(this.editView.is(":checked").toString())},beginEdit:function(){var b=this;if(a.formData.element(this.uid)){this.showEditView();this.hideStaticView();a.formData.value(this.uid)==="true"?this.editView.attr("checked","checked"):this.editView.removeAttr("checked");
this.editView.bind("blur",function(){b.blurTimeout=setTimeout(function(){b.persistChange()},250)}).bind("change",function(){if(b.blurTimeout!==-1){clearTimeout(b.blurTimeout);b.blurTimeout=-1}$(this).focus()}).bind("keydown",function(d){d.which===13&&b.persistChange(this);d.which===27&&b.cancel()});this.editView.focus()}}})})(c);(function(a){a.middleware.addStaticMethods({select:a.middleware.createChild("select-middleware")});a.middleware.select.addInstanceMethods({showStaticView:function(){var b=
a.formData.value(this.uid);b=b===""?"Click to edit":a.formData.element(this.uid).find(":selected").html();this.staticView.html(b).show();return this},createEditView:function(){var b=a.formData.element(this.uid).find("option");this.editView=$('<select class="edit-view-control select"></select>');this.editView.append(b.clone());return this}})})(c);(function(a){a.middleware.addStaticMethods({multiText:a.middleware.createChild("select-middleware")});a.middleware.multiText.addInstanceMethods({showStaticView:function(){var b=
a.formData.value(this.uid);if(b==="")b="Click to edit";this.staticView.html(b.replace(/\|/g,", ")).show();return this},persistChange:function(){var b=[];this.editView.find("input.single-text").each(function(){var d=$(this).val();d&&d!==""&&b.push($(this).val())});this.okay(b.toString().replace(/,/g,"|"));return this},beginEdit:function(){var b=this;if(a.formData.element(this.uid)){this.hideStaticView();this.showEditView();a.formData.value(this.uid).split("|").forEach(function(d){this.editView.append('<input type="text" value="'+
d+'" class="edit-view-control single-text" />')},this);this.editView.append('<input type="text" value="" class="edit-view-control single-text last" />');this.editView.bind("keydown",function(d){d.which===13&&b.persistChange();d.which===27&&b.cancel();if(d.which===9)if($(d.target).is(".last")&&d.shiftKey===false){$(d.target).removeClass("last");b.editView.append('<input type="text" value="" class="edit-view-control single-text last" />')}});this.editView.children(".last").focus();setTimeout(function(){$(document).bind("click",
{that:b},b.checkForClick)},250)}return this},checkForClick:function(b){var d=b.data.that;$(b.target).is("input",d.editView)||d.persistChange();return this},endEdit:function(){$(document).unbind("click",this.checkForClick);this.hideEditView();this.showStaticView();this.editView.empty();return this},createEditView:function(){this.editView=$('<div class="edit-view-control multi-text"></div>');return this}})})(c);(function(a){a.middleware.addStaticMethods({multiTextLimit5:a.middleware.createChild("select-middleware")});
a.middleware.multiTextLimit5.addInstanceMethods({showStaticView:function(){var b=a.formData.value(this.uid);if(b==="")b="Click to edit";this.staticView.html(b.replace(/\|/g,", ")).show();return this},persistChange:function(){var b=[];this.editView.find("input.single-text").each(function(){var d=$(this).val();d&&d!==""&&b.push($(this).val())});this.okay(b.toString().replace(/,/g,"|"));return this},beginEdit:function(){var b=this,d;if(a.formData.element(this.uid)){this.hideStaticView();this.showEditView();
d=a.formData.value(this.uid).split("|");this.length=0;d.forEach(function(e){this.editView.append('<input type="text" value="'+e+'" class="edit-view-control single-text" />');this.length++},this);for(d=this.length;d<5;d++)this.editView.append('<input type="text" value="" class="edit-view-control single-text last" />');this.editView.bind("keydown",function(e){e.which===13&&b.persistChange();e.which===27&&b.cancel()});this.editView.children(".last").focus();setTimeout(function(){$(document).bind("click",
{that:b},b.checkForClick)},250)}return this},checkForClick:function(b){var d=b.data.that;$(b.target).is("input",d.editView)||d.persistChange();return this},endEdit:function(){$(document).unbind("click",this.checkForClick);this.hideEditView();this.showStaticView();this.editView.empty();return this},createEditView:function(){this.editView=$('<div class="edit-view-control multi-text"></div>');return this}})})(c);(function(a){a.middleware.addStaticMethods({datePicker:a.middleware.createChild("middleware")});
a.middleware.datePicker.addInstanceMethods({createEditView:function(){this.editView=$('<input type="text" class="edit-view-control date-picker" />');return this},beginEdit:function(){var b=this;if(a.formData.element(this.uid)){this.hideStaticView();a.formData.element(this.uid).after(this.editView);this.editView.datepicker({onSelect:function(){b.persistChange()},onClose:function(){b.cancel()},changeYear:"true",dateFormat:"dd M yy"}).focus()}return this},endEdit:function(){this.editView.datepicker("destroy");
this.hideEditView();this.showStaticView();return this}})})(c);(function(a){a.middleware.addStaticMethods({ckEditor:a.middleware.createChild("middleware")});a.middleware.ckEditor.addInstanceMethods({createEditView:function(){this.editView=$('<textarea type="text" class="edit-view-control ckeditor" ></textarea>');return this},beginEdit:function(){var b=this;if(a.formData.element(this.uid)){this.hideStaticView();a.formData.element(this.uid).after(this.editView);this.editView.val(a.formData.value(this.uid));
this.editView.ckeditor({skin:"kama",toolbar:"Basic"});this.ckEdit=this.editView.ckeditorGet();setTimeout(function(){$(document).bind("click",{that:b},b.checkForClick)},250)}return this},endEdit:function(){$(document).unbind("click",this.checkForClick);this.ckEdit.destroy();this.hideEditView();this.showStaticView();return this},checkForClick:function(b){var d=b.data.that;$(b.target).is("#cke_editor1")||d.persistChange();return this}})})(c);(function(a){a.middleware.addStaticMethods({multiSelect:a.middleware.createChild("multiselect-middleware")});
a.middleware.multiSelect.addInstanceMethods({showStaticView:function(){console.log("creating multi select static view");var b=a.formData.value(this.uid);if(b){b="";a.formData.element(this.uid).find(":selected").each(function(){b+=$(this).html()+", "});b=b.slice(0,-2)}else b="Click to edit";this.staticView.html(b).show();return this},createEditView:function(){console.log("creating multi select edit view");var b=a.formData.element(this.uid).find("option");this.editView=$('<select class="edit-view-control multi-select" size="8" multiple="multiple"></select>');
this.editView.append(b.clone());return this},persistChange:function(){var b=this.editView.val();b&&b.length>5?console.log("static view too many selected"):this.okay(b);return this}})})(c);(function(a){a.middleware.addStaticMethods({typeAhead:a.middleware.createChild("typeahead-middleware")});a.middleware.typeAhead.addInstanceMethods({createEditView:function(){this.editView=$('<input type="text" class="edit-view-control type-ahead" />');return this},beginEdit:function(){var b=this;if(a.formData.element(this.uid)){this.hideStaticView();
a.formData.element(this.uid).after(this.editView);a.formData.element(this.uid).attr("data-lookupUrl");this.editView.val(a.formData.value(this.uid)).bind("blur",function(){b.blurTimeout=setTimeout(function(){b.cancel()},250)}).bind("keydown",function(d){d.which===27&&b.cancel()}).focus().autocomplete({source:["c++","java","php","coldfusion","javascript","asp","ruby"],select:function(d,e){b.editView.val(e.item.value);b.persistChange()},minLength:2})}return this}})})(c);(function(a){a.middleware.addStaticMethods({multiTypeAhead:a.middleware.createChild("multi-type-ahead-middleware")});
a.middleware.multiTypeAhead.addInstanceMethods({showStaticView:function(){var b=a.formData.value(this.uid);if(b==="")b="Click to edit";this.staticView.html(b.replace(/\|/g,", ")).show();return this},persistChange:function(){var b=[];this.editView.find("input.single-text").each(function(){var d=$(this).val();d&&d!==""&&b.push($(this).val())});this.okay(b.toString().replace(/,/g,"|"));return this},beginEdit:function(){var b=this,d;if(a.formData.element(this.uid)){this.hideStaticView();this.showEditView();
d=a.formData.value(this.uid).split("|");this.length=0;d.forEach(function(e){this.editView.append('<input type="text" value="'+e+'" class="edit-view-control single-text" />');this.length++},this);for(d=this.length;d<5;d++)this.editView.append('<input type="text" value="" class="edit-view-control single-text last" />');this.editView.children().each(function(){$(this).autocomplete({source:["c++","java","php","coldfusion","javascript","asp","ruby"],select:function(e,g){$(this).val(g.item.value)},minLength:2}).bind("blur",
function(){})});this.editView.bind("keydown",function(e){e.which===13&&b.persistChange();e.which===27&&b.cancel()});this.editView.children(".last").focus();setTimeout(function(){$(document).bind("click",{that:b},b.checkForClick)},250)}return this},checkForClick:function(b){var d=b.data.that;!$(b.target).is("input",d.editView)&&!$(b.target).is("ul.ui-autocomplete li a")&&d.persistChange();return this},endEdit:function(){$(document).unbind("click",this.checkForClick);this.hideEditView();this.showStaticView();
this.editView.empty();return this},createEditView:function(){this.editView=$('<div class="edit-view-control multi-text"></div>');return this}})})(c);h.base=f})(window);
